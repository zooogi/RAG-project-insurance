# RAGä¿é™©é¡¹ç›®

åŸºäºæ£€ç´¢å¢å¼ºç”Ÿæˆ(RAG)çš„ä¿é™©æ–‡æ¡£æ™ºèƒ½é—®ç­”ç³»ç»Ÿã€‚

 
## ğŸ“ é¡¹ç›®ç»“æ„

```
RAG-ä¿é™©é¡¹ç›®/
â”œâ”€â”€ app/                    # åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ ocr.py             # PDFå¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ embedder.py        # æ–‡æœ¬å‘é‡åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ chunker.py         # æ–‡æœ¬åˆ†å—æ¨¡å—
â”‚   â”œâ”€â”€ reranker.py        # æ£€ç´¢å’Œé‡æ’åºæ¨¡å—
â”‚   â”œâ”€â”€ config.py          # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ main.py            # ä¸»ç¨‹åº
|
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•ï¼ˆè¯¦è§ docs/DATA_STRUCTURE.mdï¼‰
â”‚   â”œâ”€â”€ raw_data/          # åŸå§‹æ•°æ®ï¼ˆPDF/å›¾ç‰‡ç­‰ï¼‰
â”‚   â”œâ”€â”€ processed/         # OCRå¤„ç†åçš„Markdownæ–‡ä»¶
â”‚   â”œâ”€â”€ cleaned/           # æ–‡æœ¬æ¸…æ´—åçš„Markdownæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ chunks/            # åˆ†å—åçš„JSONæ–‡ä»¶ï¼ˆæœ€ç»ˆç”¨äºembeddingï¼‰
|
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”‚   â”œâ”€â”€ DATA_STRUCTURE.md  # ğŸ“‹ æ•°æ®ç›®å½•ç»“æ„è¯´æ˜ï¼ˆé‡è¦ï¼ï¼‰
â”‚   â”œâ”€â”€ RAG_PIPELINE_USAGE.md  # ğŸš€ RAG Pipelineå®Œæ•´æµç¨‹ä½¿ç”¨æŒ‡å—ï¼ˆæ¨èï¼ï¼‰
â”‚   â”œâ”€â”€ OCR_USAGE.md       # OCRæ¨¡å—ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ CHUNKER_USAGE.md   # Chunkeræ¨¡å—ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ TEXT_CLEANER_USAGE.md  # æ–‡æœ¬æ¸…æ´—æ¨¡å—ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ SEMANTIC_CHUNKER_USAGE.md  # è¯­ä¹‰åˆ‡å‰²å’Œæœ¯è¯­æå–ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ EMBEDDER_USAGE.md  # Embedderä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ RERANKER_USAGE.md  # Rerankerä½¿ç”¨æŒ‡å—
â”‚   â””â”€â”€ LLM_USAGE.md       # LLMä½¿ç”¨æŒ‡å—
â”œâ”€â”€ scripts/                # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ Full_RAG_TEST.sh   # ğŸš€ å®Œæ•´RAGæµç¨‹æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼ï¼‰
â”‚   â”œâ”€â”€ test_ocr.py        # OCRæµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_embed.py      # Embedderæµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_chunker.py    # Chunkeræµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_reranker.py   # Rerankeræµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_llm.py        # LLMæµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ download_embed.py  # ä¸‹è½½å‘é‡æ¨¡å‹
â”œâ”€â”€ requirements.txt        # Pythonä¾èµ–
â””â”€â”€ README.md              # æœ¬æ–‡ä»¶
```

## âœ¨ ä¸»è¦åŠŸèƒ½

### 1. PDFæ–‡æ¡£å¤„ç† (OCRæ¨¡å—)
- æ”¯æŒæ–‡å­—ç‰ˆå’Œæ‰«æç‰ˆPDF
- è‡ªåŠ¨æå–æ–‡æœ¬ã€è¡¨æ ¼å’Œå›¾ç‰‡
- åŒå¼•æ“æ”¯æŒï¼šMineRUï¼ˆé«˜çº§ï¼‰+ PyMuPDFï¼ˆå¤‡é€‰ï¼‰
- è¾“å‡ºMarkdownå’Œçº¯æ–‡æœ¬æ ¼å¼

### 2. æ–‡æœ¬åˆ†å— (Chunkeræ¨¡å—)
- **åŸºç¡€åˆ†å—**ï¼šåŸºäºè¯­ä¹‰çš„æ™ºèƒ½åˆ†å—ï¼Œä¿ç•™æ–‡æ¡£ç»“æ„ä¸Šä¸‹æ–‡ï¼ˆæ ‡é¢˜å±‚çº§ï¼‰
- **è¯­ä¹‰åˆ‡å‰²**ï¼šè¯†åˆ«è¯­ä¹‰ç±»å‹ï¼ˆç»™ä»˜ã€å…è´£ã€æ¡ä»¶ã€å®šä¹‰ç­‰ï¼‰ï¼ŒæŒ‰è¯­ä¹‰åŸå­æ‹†åˆ†
- **æœ¯è¯­æå–**ï¼šæå–ä¿é™©ä¸šåŠ¡ä¸“ä¸šæœ¯è¯­ï¼Œå†™å…¥chunk metadata
- **è¯­ä¹‰é™å™ª**ï¼šè¯†åˆ«å¹¶è·³è¿‡é‡å¤è¯æœ¯å’Œå…œåº•è¯æœ¯ï¼ˆä¸å½±å“åŸå§‹æ–‡æœ¬ï¼‰
- **è¡¨æ ¼å¤„ç†**ï¼šè¡¨æ ¼ä½œä¸ºä¸å¯æ‹†åˆ†çš„åŸå­å•å…ƒ
- **å›¾ç‰‡å¤„ç†**ï¼šè¯†åˆ«å¹¶è®°å½•å›¾ç‰‡å¼•ç”¨ï¼Œä¸å‚ä¸embedding
- **ç»Ÿä¸€è¾“å‡º**ï¼šç»“æ„åŒ–çš„JSONæ ¼å¼ï¼ŒåŒ…å«ä¸°å¯Œçš„metadataä¿¡æ¯

### 3. æ–‡æœ¬å‘é‡åŒ– (Embedderæ¨¡å—)
- ä½¿ç”¨bge-large-zh-v1.5ä¸­æ–‡å‘é‡æ¨¡å‹
- æ”¯æŒæ–‡æ¡£å’ŒæŸ¥è¯¢çš„å‘é‡åŒ–
- é«˜æ•ˆçš„è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—

### 4. æ£€ç´¢å’Œé‡æ’åº (Rerankeræ¨¡å—)
- **Rankingé˜¶æ®µ**ï¼šä½¿ç”¨Faissè¿›è¡Œé«˜æ•ˆçš„å‘é‡æ£€ç´¢
- **Rerankingé˜¶æ®µ**ï¼šä½¿ç”¨bge-reranker-largeè¿›è¡Œç²¾ç»†é‡æ’åº
- æ”¯æŒmetadataåŠ æƒï¼ˆåˆ©ç”¨ç« èŠ‚è·¯å¾„ã€chunkç±»å‹ç­‰ä¿¡æ¯ï¼‰
- ä¸¤é˜¶æ®µæ£€ç´¢æµç¨‹ï¼Œå…¼é¡¾æ•ˆç‡å’Œå‡†ç¡®æ€§

### 5. LLMç”Ÿæˆ (LLMæ¨¡å—)
- ä½¿ç”¨Qwen2.5-3B-Instructæ¨¡å‹è¿›è¡Œç­”æ¡ˆç”Ÿæˆï¼ˆé»˜è®¤ï¼Œçº¦6-8GBæ˜¾å­˜ï¼‰
- æ”¯æŒæ›´å°æ¨¡å‹ï¼šQwen2.5-1.5B-Instructï¼ˆçº¦3-4GBæ˜¾å­˜ï¼‰
- è‡ªåŠ¨æ„å»ºRAG promptï¼ˆæŸ¥è¯¢ + æ£€ç´¢åˆ°çš„chunksï¼‰
- æ”¯æŒæ¨¡å‹ç¼“å­˜æœºåˆ¶ï¼ŒèŠ‚çœæ˜¾å­˜
- å¯è°ƒèŠ‚ç”Ÿæˆå‚æ•°ï¼ˆtemperatureã€top_pç­‰ï¼‰

### 6. RAG Pipeline (å®Œæ•´æµç¨‹)
- **ä¸€é”®å¤„ç†**ï¼šOCR -> æ¸…æ´— -> Chunk -> Embeddingç´¢å¼•æ„å»º
- **æ™ºèƒ½æŸ¥è¯¢**ï¼šæ£€ç´¢ -> Rerank -> LLMç”Ÿæˆç­”æ¡ˆ
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰æ‰€æœ‰æ¨¡å—å‚æ•°
- **å‘½ä»¤è¡Œæ¥å£**ï¼šæ”¯æŒå‘½ä»¤è¡Œå’ŒPython APIä¸¤ç§ä½¿ç”¨æ–¹å¼
- è¯¦è§ï¼š[RAG Pipelineä½¿ç”¨æŒ‡å—](docs/RAG_PIPELINE_USAGE.md)

### 7. APIæ¥å£


## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <your-repo-url>
cd RAG-ä¿é™©é¡¹ç›®

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
conda create -n rag python=3.10
conda activate rag

# åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼ˆè®¾ç½®å›½å†…é•œåƒç¯å¢ƒï¼‰ï¼ˆåšå¥½ä¼˜å…ˆè®¾ç½®å¥½ç¯å¢ƒï¼ï¼ï¼ï¼‰
export HF_ENDPOINT=https://hf-mirror.com

# 3. å®‰è£…ä¾èµ–åŒ…
pip install -r requirements.txt

# ä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿï¼ˆå¯é€‰ï¼‰
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### é¦–æ¬¡ä½¿ç”¨é…ç½®

#### ä½¿ç”¨MineRUï¼ˆæ¨èï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼‰

```bash
# å®‰è£…MineRUå’Œä¾èµ–
# ä¸‹è½½ä¾èµ–åŒ…å·²ç»åŒ…å«äº†å®‰è£…MineRU
pip install -r requirements.txt
#pip install mineru>=2.7.0 accelerate>=0.20.0

#check æœ‰å†…å®¹å°±æ˜¯ä¸‹è½½æˆåŠŸ
mineru --help

# test é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼ˆçº¦1-2GBï¼Œéœ€è¦æ—¶é—´ï¼‰
mineru -p data/pdf/ä¿é™©åŸºç¡€çŸ¥å¤šå°‘.pdf -o data/mineru_test --source modelscope
```

#### ä½¿ç”¨RAG Pipelineï¼ˆæ¨èï¼å®Œæ•´æµç¨‹ï¼‰

```python
# æ–¹å¼1: Python API
from app.main import RAGPipeline
from pathlib import Path

# åˆ›å»ºpipeline
pipeline = RAGPipeline()

# å¤„ç†æ–‡æ¡£ï¼ˆOCR -> æ¸…æ´— -> Chunk -> æ„å»ºç´¢å¼•ï¼‰
result = pipeline.process_documents(
    input_path=Path("data/raw_data"),
    overwrite=False
)

# æŸ¥è¯¢ç­”æ¡ˆ
answer = pipeline.query("å¦‚ä½•ç”³è¯·æ„å¤–é™©ç†èµ”ï¼Ÿ")
print(answer["answer"])
```

```bash
# æ–¹å¼2: å‘½ä»¤è¡Œæ¥å£

# å¤„ç†æ–‡æ¡£
python -m app.main process --input data/raw_data

# æŸ¥è¯¢
python -m app.main query --query "å¦‚ä½•ç”³è¯·æ„å¤–é™©ç†èµ”ï¼Ÿ"
```

**å¿«é€Ÿæµ‹è¯•**ï¼š
```bash
# æŸ¥çœ‹å®Œæ•´æµ‹è¯•è„šæœ¬ï¼ˆåŒ…å«å¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
cat scripts/Full_RAG_TEST.sh

# æˆ–ç›´æ¥è¿è¡Œæµ‹è¯•è„šæœ¬
bash scripts/Full_RAG_TEST.sh

# æŒ‰ç…§è„šæœ¬ä¸­çš„å‘½ä»¤ä¾æ¬¡æµ‹è¯•ï¼š
# 1. å¤„ç†æ–‡æ¡£ï¼ˆå‰æï¼šdata/raw_data ç›®å½•ä¸‹æœ‰åŸå§‹æ•°æ®ï¼‰
python -m app.main process --input data/raw_data

# 2. æµ‹è¯•ä¸åŒç±»å‹çš„æŸ¥è¯¢
python -m app.main query --query "å¦‚æœæˆ‘ä»Šå¹´45å²ï¼Œå‹é‚¦ç»ˆèº«å¯¿é™©å¯ä»¥é€‰æ‹©å“ªäº›ä»˜è´¹å¹´é™ï¼Ÿ"
python -m app.main query --query "å¸çƒŸè€… (smoker=yes) çš„å¹³å‡ä¿é™©è´¹ç”¨(Average charges)æ˜¯å¤šå°‘ï¼Ÿ"
python -m app.main query --query "åœ¨çŸ¥è¯†åº“é‡Œçš„ä¸€ä»½å›¾ç‰‡åˆåŒè¯´æ˜ï¼Œè¿™æ¬¾é™„åŠ åˆåŒçš„ä¿é™©æœŸé—´æ˜¯å¤šä¹…"
```

è¯¦è§ï¼š[RAG Pipelineä½¿ç”¨æŒ‡å—](docs/RAG_PIPELINE_USAGE.md)

#### ä½¿ç”¨Embeddingå’ŒRerankerï¼ˆå•ç‹¬ä½¿ç”¨ï¼‰

```bash
# æµ‹è¯•Embedderæ¨¡å—
python scripts/test_embed.py

# æµ‹è¯•Rerankeræ¨¡å—ï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼‰
python scripts/test_reranker.py

# æµ‹è¯•LLMæ¨¡å—ï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼Œçº¦6GBï¼‰
python scripts/test_llm.py
```

**æ³¨æ„**ï¼š
- Rerankerä½¿ç”¨`BAAI/bge-reranker-large`æ¨¡å‹ï¼Œé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ï¼ˆçº¦1-2GBï¼‰
- LLMä½¿ç”¨`Qwen/Qwen2.5-3B-Instruct`æ¨¡å‹ï¼Œé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ï¼ˆçº¦6GBï¼‰
- **é»˜è®¤ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆhf-mirror.comï¼‰åŠ é€Ÿä¸‹è½½**
- å¦‚æœä½¿ç”¨GPUï¼Œå»ºè®®å®‰è£…`faiss-gpu`ä»¥æå‡æ£€ç´¢é€Ÿåº¦
- **æ˜¾å­˜éœ€æ±‚**ï¼š
  - Qwen2.5-3Bï¼šçº¦6-8GBæ˜¾å­˜ï¼ˆé»˜è®¤ï¼‰
  - Qwen2.5-1.5Bï¼šçº¦3-4GBæ˜¾å­˜ï¼ˆæ˜¾å­˜ä¸è¶³æ—¶ä½¿ç”¨ï¼‰
  - **æ˜¾å­˜ä¼˜åŒ–**ï¼šæ”¯æŒ8bit/4bité‡åŒ–ï¼Œå¯å¤§å¹…é™ä½æ˜¾å­˜éœ€æ±‚
    - 8bité‡åŒ–ï¼šæ˜¾å­˜å‡åŠï¼ˆ3-4GBï¼‰
    - 4bité‡åŒ–ï¼šæ˜¾å­˜å‡å°‘75%ï¼ˆ1.5-2GBï¼‰
    - å®‰è£…é‡åŒ–åº“ï¼š`pip install bitsandbytes`
  - å¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨CPUæ¨¡å¼æˆ–æ›´å°çš„æ¨¡å‹
- æ¨¡å‹ä¼šè‡ªåŠ¨ç¼“å­˜åˆ°`~/.cache/huggingface/hub/`ç›®å½•

**æ˜¾å­˜ä¼˜åŒ–ç¤ºä¾‹**ï¼š
```python
from app.config import RAGPipelineConfig
from app.main import RAGPipeline

# ä½¿ç”¨4bité‡åŒ–ï¼ˆæ˜¾å­˜ä»6-8GBé™åˆ°1.5-2GBï¼‰
config = RAGPipelineConfig(
    llm_load_in_4bit=True
)
pipeline = RAGPipeline(config)
```

## ğŸ“‹ æ•°æ®ç›®å½•è¯´æ˜

**é‡è¦**ï¼šè¯·å…ˆé˜…è¯» [æ•°æ®ç›®å½•ç»“æ„è¯´æ˜æ–‡æ¡£](docs/DATA_STRUCTURE.md)ï¼Œäº†è§£ `data/` ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„å«ä¹‰å’Œç”¨é€”ã€‚

### ğŸ“‚ ç›®å½•å¿«é€Ÿå‚è€ƒ

| ç›®å½• | å†…å®¹ | ç”¨é€” | æ˜¯å¦å¿…éœ€ |
|------|------|------|---------|
| `raw_data/` | PDF/å›¾ç‰‡/CSV | åŸå§‹è¾“å…¥æ•°æ®ï¼ˆä¸ä¼šè¢«ä¿®æ”¹ï¼‰ | âœ… å¿…éœ€ |
| `processed/` | `*.md` + ä¸­é—´æ–‡ä»¶ | OCRå¤„ç†åçš„Markdownï¼ˆä¸»è¦è¾“å‡ºï¼‰ | âœ… å¿…éœ€ |
| `cleaned/` | `*.md` | æ–‡æœ¬æ¸…æ´—åçš„Markdownï¼ˆæŸ¥çœ‹æ•ˆæœç”¨ï¼‰ | âš ï¸ å¯é€‰ |
| `chunks/` | `*_chunks.json` | æœ€ç»ˆç”¨äºembeddingçš„chunkæ•°æ® | âœ… å¿…éœ€ |
| `mineru_test/` | æµ‹è¯•æ–‡ä»¶ | MineRUæµ‹è¯•è¾“å‡º | âŒ å¯åˆ é™¤ |

### ğŸ”„ æ•°æ®æµç¨‹

```
raw_data/*.pdf 
  â†“ [OCRå¤„ç†]
processed/**/*.md (ä¸»è¦è¾“å‡º)
  â†“ [æ–‡æœ¬æ¸…æ´—ï¼Œå¯é€‰]
cleaned/**/*.md (æŸ¥çœ‹æ¸…æ´—æ•ˆæœ)
  â†“ [Chunkeråˆ†å—]
chunks/*_chunks.json â­ (æœ€ç»ˆç”¨äºembedding)
```

### ğŸ“ é‡è¦æ–‡ä»¶è¯´æ˜

- **`processed/**/*.md`**ï¼šOCRçš„ä¸»è¦è¾“å‡ºï¼ŒåŒ…å«æ–‡æœ¬ã€è¡¨æ ¼ã€å›¾ç‰‡å¼•ç”¨
- **`chunks/*_chunks.json`**ï¼šæœ€ç»ˆç”¨äºembeddingçš„æ•°æ®ï¼ŒåŒ…å«ï¼š
  - `text`ï¼šåŸå§‹æ–‡æœ¬
  - `embedding_text`ï¼šç”¨äºembeddingçš„æ–‡æœ¬ï¼ˆå·²è¿‡æ»¤è·³è¿‡embeddingçš„å¥å­ï¼‰
  - `metadata`ï¼šä¸°å¯Œçš„å…ƒæ•°æ®ï¼ˆè¯­ä¹‰ç±»å‹ã€æœ¯è¯­ã€ç« èŠ‚è·¯å¾„ç­‰ï¼‰
  - `sentence_infos`ï¼šå¥å­çº§åˆ«çš„ä¿¡æ¯

### ğŸ§¹ æ¸…ç†å»ºè®®

**å¯ä»¥åˆ é™¤**ï¼š
- `cleaned/` ç›®å½•ï¼ˆå¦‚æœä¸éœ€è¦æŸ¥çœ‹æ¸…æ´—æ•ˆæœï¼‰
- `mineru_test/` ç›®å½•ï¼ˆæµ‹è¯•æ–‡ä»¶ï¼‰
- `chunks/test_*.json`ï¼ˆæµ‹è¯•æ•°æ®ï¼‰
- `processed/**/*_*.json`ã€`*_layout.pdf` ç­‰OCRä¸­é—´æ–‡ä»¶

**å¿…é¡»ä¿ç•™**ï¼š
- `raw_data/`ï¼ˆåŸå§‹æ•°æ®å¤‡ä»½ï¼‰
- `processed/**/*.md`ï¼ˆOCRè¾“å‡ºï¼‰
- `chunks/*_chunks.json`ï¼ˆç”Ÿäº§æ•°æ®ï¼Œæ’é™¤test_*.jsonï¼‰

è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ï¼š[docs/DATA_STRUCTURE.md](docs/DATA_STRUCTURE.md)
